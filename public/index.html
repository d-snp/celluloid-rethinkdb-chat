<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.12.2/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.12.2/JSXTransformer.js"></script>
    <script src="ddp.js"></script>
  </head>
  <body>
    <div id="example"></div>
    <script type="text/jsx">
      var ChatView = React.createClass({
        getInitialState: function() {
          return {data: []};
        },
        componentDidMount: function() {
          this.loadLines();
        },

        loadLines: function() {
          var options = {
            endpoint: "ws://localhost:3000/websocket",
            SocketConstructor: WebSocket
          };

          var ddp = this.ddp = new DDP(options);
          var self = this;
          ddp.on("connected", function() {
            console.log("Connected to DDP Server")
            ddp.sub("messages");
            ddp.on("added", function (data) {
              console.log("Got data", data)
              var state = self.state;
              state.data.push(data.fields);
              self.setState(state);
            });
          });

          // $.ajax({
          //   url: this.props.url,
          //   dataType: 'json',
          //   success: function(data) {
          //     this.setState({data: data});
          //   }.bind(this),
          //   error: function(xhr, status, err) {
          //     console.error(this.props.url, status, err.toString());
          //   }.bind(this)
          // });
        },
        handleChatLineSubmit: function(text) {
          this.ddp.method('send_message', text, function(result) {
            console.log("Got sendmessage result:", result)
          });
        },
        render: function() {
          return (
            <div className="chatView">
              <h1>Chat</h1>
              <ChatBox data={this.state.data} />
              <ChatInput onChatLineSubmit={this.handleChatLineSubmit} />
            </div>
          );
        }
      });

      var ChatLine = React.createClass({
        render: function() {
          return (
            <li>
              <span className="chatLineAuthor">
                {this.props.author}
              </span>
              {this.props.children}
            </li>
          );
        }
      });

      var ChatBox = React.createClass({
        render: function() {
          var lineNodes = this.props.data.map(function(line) {
            return ( <ChatLine author={line.author}>{line.text}</ChatLine> )
          });
          return (
            <div class="chatBox">
              <ol>
                {lineNodes}
              </ol>
            </div>
          );
        }
      });

      var ChatInput = React.createClass({
        handleSubmit: function(e) {
          e.preventDefault();
          var text = this.refs.text.getDOMNode().value.trim();
          if (!text) {
            return;
          }
          this.props.onChatLineSubmit(text);
          this.refs.text.getDOMNode().value = '';
        },
        render: function() {
          return (
            <form className="chatInput" onSubmit={this.handleSubmit}>
              <input type="text" ref="text" placeholder="Say something..." />
              <input type="submit" value="Post" />
            </form>
          );
        }
      });

      var data = [
        {author: "Pete Hunt", text: "This really is one comment"},
        {author: "Jordan Walke", text: "This is *another* comment"}
      ];

      React.render(
        <ChatView data={data} />,
        document.getElementById('example')
      );
    </script>
  </body>
</html>
